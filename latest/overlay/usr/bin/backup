#!/usr/bin/env bash
set -eo pipefail
source /usr/bin/entrypoint

DATABASES=$(PGPASSWORD=${POSTGRESQL_ROOT_PASSWORD} psql --username=postgres -w -A -t -c "SELECT datname FROM pg_database" | grep -v -E "${POSTGRESQL_BACKUP_IGNORE}")
MAXIMUM=${POSTGRESQL_BACKUP_RETENTION}

if [ "${DATABASES}" == "" ]; then
    exit
fi

if [ ! -d ${POSTGRESQL_BACKUP_PATH} ]; then
    mkdir -p ${POSTGRESQL_BACKUP_PATH}
    chmod u=rwx,g=rwx,o= ${POSTGRESQL_BACKUP_PATH}
fi

for (( COUNTER=${MAXIMUM}; COUNTER>=1; COUNTER-- )); do
    if [ -d ${POSTGRESQL_BACKUP_PATH}/backup.${COUNTER} ]; then
        DEST=`expr ${COUNTER} + 1`

        if [ ${DEST} -le ${MAXIMUM} ]; then
            rm -rf ${POSTGRESQL_BACKUP_PATH}/backup.${DEST}
            mv ${POSTGRESQL_BACKUP_PATH}/backup.${COUNTER} ${POSTGRESQL_BACKUP_PATH}/backup.${DEST}
        fi
    fi
done

mkdir -p ${POSTGRESQL_BACKUP_PATH}/backup.1
chmod u=rwx,g=rwx,o= ${POSTGRESQL_BACKUP_PATH}/backup.1

cd ${POSTGRESQL_BACKUP_PATH}/backup.1

for DATABASE in ${DATABASES}; do
    echo "Starting backup for ${DATABASE}..."
    START=$(date +%s)
    PGPASSWORD=${POSTGRESQL_ROOT_PASSWORD} pg_dump -w --username=postgres --dbname=${DATABASE} --file=${DATABASE}.sql
    gzip ${DATABASE}.sql
    chmod u=rwx,g=rwx,o= "${DATABASE}.sql.gz"
    ENDS=$(date +%s)
    echo "Done within $((${ENDS}-${START}))s"
done
